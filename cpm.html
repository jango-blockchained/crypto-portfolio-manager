<html>
<head>
<title>My Crypto Portfolio</title>
<!-- Bootstrap -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.17/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/select/1.2.6/css/select.dataTables.min.css">
<link rel="stylesheet" href="https://editor.datatables.net/extensions/Editor/css/editor.dataTables.min.css">
<style>
html{font-size:14px}
@media(min-width:768px){
    html{font-size:16px}
}
.container{max-width:960px}
</style>
</head>
<body>
    <header>
        <div class="collapse bg-dark" id="navbarHeader">
            <div class="container">
                <div class="row">
                    <div class="col-sm-8 col-md-7 py-4">
                      <h4 class="text-white">About CPM</h4>
                      <p class="text-muted">Made in Switzerland</p>
                    </div>
                    <div class="col-sm-4 offset-md-1 py-4">
                      <h4 class="text-white">Contact</h4>
                      <ul class="list-unstyled">
                        <li><a href="https://twitter.com/samhessCH" target="_blank" class="text-white">Follow on Twitter</a></li>
                        <li><a href="https://www.facebook.com/samhess.ch" target="_blank" class="text-white">Like on Facebook</a></li>
                        <li><a href="mailto:sam.hess@bluewin.ch?subject=CPM" class="text-white">Email me</a></li>
                      </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="navbar navbar-dark bg-dark box-shadow">
            <div class="container d-flex justify-content-between">
                <a href="#" class="navbar-brand d-flex align-items-center">
                <strong>Crypto Portfolio Manager</strong>
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </div>
    </header>
    <main role="main">
        <section class="jumbotron text-center">
            <div class="container">
                <h1 class="jumbotron-heading">Crypto Portfolio Manager</h1>
                <p class="lead text-muted">Create, manage, track and analyse crypto portfolios!</p>
            </div>
        </section>
        <div class="container">  
            <div class="row"> 
                <div class="col-md-6 order-md-2 mb-4">    
                    <ul class="list-group mb-0">
                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                            <p>Market Capitalisation</p>
                            <p id="marketcap" class="text-muted">n/a</p>
                        </li>
                    </ul>
                </div>
                <div class="col-md-6 order-md-2 mb-4">    
                    <ul id="portfolioInfo" class="list-group mb-0">
                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                            <p>Portfolio Value</p>
                            <p id="portfolioValue" class="text-muted">n/a</p>
                        </li>
                        <li class="list-group-item d-flex justify-content-between lh-condensed">
                            <p>Market to Portfolio Ratio</p>
                            <p id="m2pRatio" class="text-muted">n/a</p>
                        </li>
                    </ul>
                </div>
            </div>
            <div class=""> 
                <div class="btn-toolbar mb-2 mb-md-2">
                    <div class="mr-2 ml-auto">
                        <label class="ml-3" for="investmentSum">Investment sum:</label>
                            <input class="ml-1" type='text' id='investmentSum' size='6' value='1000'>
                        <label class="ml-3" for="strategy">Strategy:</label>
                            <select class="ml-1" id="strategy">
                                <option value="2">Top 2</option>
                                <option value="5">Top 5</option>
                                <option value="10" selected>Top 10</option>
                                <option value="20">Top 20</option>
                                <option value="custom">Custom limit</option>
                            </select>
                        <label class="ml-3" for="currency">Currency:</label>
                            <select class="ml-1" id="currency"><option>USD</option><option>CHF</option></select> 
                    </div>
                </div>
            </div>
            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <a class="nav-item nav-link active" id="nav-overview-tab" data-toggle="tab" href="#nav-overview" role="tab" aria-controls="nav-overview" aria-selected="true">Market Overview</a>
                    <a class="nav-item nav-link" id="nav-definition-tab" data-toggle="tab" href="#nav-definition" role="tab" aria-controls="nav-definition" aria-selected="false">Real Portfolio</a>
                    <a class="nav-item nav-link" id="nav-generation-tab" data-toggle="tab" href="#nav-generation" role="tab" aria-controls="nav-generation" aria-selected="false">Virtual Portfolio</a>
                    <a class="nav-item nav-link" id="nav-analysis-tab" data-toggle="tab" href="#nav-analysis" role="tab" aria-controls="nav-analysis" aria-selected="false">Portfolio Analysis</a>
                    <a class="nav-item nav-link" id="nav-performance-tab" data-toggle="tab" href="#nav-performance" role="tab" aria-controls="nav-performance" aria-selected="false">Performance</a>
                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-overview" role="tabpanel" aria-labelledby="nav-home-tab">
                    <br>
                    <table id="tableOverview" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    </table>      
                </div>
                <div class="tab-pane fade" id="nav-definition" role="tabpanel" aria-labelledby="nav-profile-tab">
                    <br>
                    <table id="tablePortfolio" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    </table> 
                </div>
                <div class="tab-pane fade" id="nav-generation" role="tabpanel" aria-labelledby="nav-profile-tab">
                    <br>
                    <table id="tableVirtual" class="table table-striped table-bordered" cellspacing="0" width="100%">
                    </table> 
                </div>
                <div class="tab-pane fade" id="nav-analysis" role="tabpanel" aria-labelledby="nav-contact-tab">
                    <p>Select portfolio to analyze: 
                        <select class="ml-1" id="portfolioSelection">
                            <option value="real" selected>real portfolio</option>
                            <option value="virtual">virtual portfolio</option>
                        </select>
                    </p>
                    <table class="table">
                        <thead class="thead-light">
                        <tr><th>#</th><th>Amount</th><th>Coin</th><th>Portfolio Share</th><th>Market Share</th><th>Weight</th></tr>
                        </thead>
                        <tbody id="analysis">
                        </tbody>
                    </table> 
                </div>
                <div class="tab-pane fade" id="nav-performance" role="tabpanel" aria-labelledby="nav-contact-tab">
                    <br>
                    <div class="row">  
                        <div class="col-3">  
                            <p>Status:</p>
                        </div> 
                        <div class="col-9">  
                            <p id="status"></p>
                        </div> 
                    </div> 
                    <div class="row">  
                        <div class="col-3">  
                            <p>Start date:</p>
                        </div> 
                        <div class="col-9">  
                            <input id="startDate" type="date"> 
                        </div> 
                    </div> 
                    <div class="row">  
                        <div class="col-3">  
                            <p>Number of coins</p>
                        </div> 
                        <div class="col-9">  
                            <input id="numberOfCoins" type="number" value="1"> 
                        </div> 
                    </div> 
                    <div class="row">  
                        <div class="col-3">  
                            <p>Normalize prices</p>
                        </div> 
                        <div class="col-9">  
                            <input id="normalizePrices" type="checkbox" checked> 
                        </div> 
                    </div> 
                    <div class="row">  
                        <div class="col-3">  
                        </div> 
                        <div class="col-9">  
                            <button id="updateChart" class="ml-3" type="button" >update</button>
                        </div> 
                    </div> 
                    <canvas class="my-4 w-100" id="myChart"></canvas>
                </div>
            </div>
            <br>
            <hr>
        </div>
    </main>
    <footer class="container">
      <div class="container">
        <p class="float-right">
          <a href="#">Back to top</a>
        </p>
        <p>Â© Crypto Portfolio Manager 2018</p>
      </div>
    </footer>

   
    <!-- Modal add -->
    <div class="modal fade" id="modalAdd" tabindex="-1" role="dialog" aria-labelledby="modalAddTitle" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalAddTitle">Add record</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" name="apply" data-toggle="modal" data-target="#modalAdd">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery,Popper.js and Bootstrap JS, -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
    <script src="https://cdn.datatables.net/1.10.17/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.17/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.colVis.min.js"></script> <!-- column visibility button -->
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script> <!-- export button -->
    <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script> <!-- print button -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script> <!-- required HTML5 export buttons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script> <!-- required HTML5 export buttons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script> <!-- required by pdfmake -->
    <script src="https://cdn.datatables.net/select/1.2.6/js/dataTables.select.min.js"></script>
    <script type="application/javascript">
var currency = 'USD';
var locale = 'de-CH';
var coinListLimit = 500;
var coinList = {}; // associative array which is an object in Javascript
var sortableCoinList = []; // sortable array
var total_market_cap = 0;
var active_cryptocurrencies = 0;
var portfolio_value = 0; 
var portfolio; 
var virtualPortfolio = []; 
var historicalPrices = []; 
var histCoinLimit = 20; 
/**
* Make AJAX calls to CMC API, endpoint global
*/
function getMarketInfo() {
    $.get( 'https://api.coinmarketcap.com/v2/global/', { "convert": currency }, function( data ) {
        total_market_cap = data.data.quotes[currency].total_market_cap;
        active_cryptocurrencies = data.data.active_cryptocurrencies;
        // get the coin infos
        getCoinList();
    });
}

/**
* Make AJAX calls to CMC API, endpoint global ticker, maximum 100 items per call
*/
function getCoinList() {
    var numberOfReq = Math.ceil(coinListLimit/100)
    var req = [];
    for (var i=0; i<numberOfReq; i++){
        var limit = (i+1 != numberOfReq) ? 100 : coinListLimit % 100;
        req.push($.get(  'https://api.coinmarketcap.com/v2/ticker/', { "convert": currency, "start": i*100+1, "limit":limit }))
    }
    $.when(...req).done(function() {
        var data = {}
        if (req.length > 1 && arguments[0][1] == 'success') { // array of jqXHR responses due to multiple ajax calls
            for( var i=0; i<arguments.length; i++ ){
                // merge data to single data object
                if (arguments[i][1] == 'success') {
                    Object.assign(data, arguments[i][0].data)
                } else {
                    console.log('error: ' + arguments[i])
                }
            }
        } else if (arguments[1] == 'success') { // single xhr response due to single ajax call
            data = arguments[0].data
        }
        sortableCoinList = [];
        for (var key in data) {
            coinList[data[key].symbol] = data[key];
            sortableCoinList.push(data[key]);
        }
        sortableCoinList.sort(function (a, b) {
            return a.rank - b.rank;
        });
        fetchHistoricalPrices(sortableCoinList.slice(0,histCoinLimit));
        showOverview()
        // console.log(coinList)
    });    
}

/**
* Show overview on home page
*/
function showOverview() {
    $("#marketcap").html(total_market_cap.toLocaleString(locale,  { style: 'currency', currency: currency }));     
    
    var dtApi = $('#tableOverview').DataTable();
    dtApi.clear();
    for (var key in sortableCoinList) {
        var rank = sortableCoinList[key].rank;
        var symbol = sortableCoinList[key].symbol;
        var name = sortableCoinList[key].name;
        var market_cap = sortableCoinList[key].quotes[currency].market_cap;
        var market_share = market_cap / total_market_cap;
        var price = sortableCoinList[key].quotes[currency].price;
        var percent_change_1h = sortableCoinList[key].quotes[currency].percent_change_1h;
        var percent_change_24h = sortableCoinList[key].quotes[currency].percent_change_24h;
        var percent_change_7d = sortableCoinList[key].quotes[currency].percent_change_7d;
        dtApi.row.add([rank, name + ' (' + symbol + ')', price, percent_change_1h, percent_change_24h, percent_change_7d, market_share]);
    }
    dtApi.columns.adjust();
    dtApi.draw();
}

function definePortfolio() {
    var datatable = $('#tablePortfolio').DataTable();
    datatable.clear();
    for (var key in portfolio.object) { // portfolio is a proxy to localStorage, object returns an object
        var coin = {}
        coin.symbol = key;
        coin.amount = portfolio[key];
        if (key in coinList) {
            coin.rank = coinList[key].rank
            coin.name = coinList[key].name
            coin.market_cap = coinList[key].quotes[currency].market_cap
        } else {
            console.log('Warning: ' + key + ' not in coin list')
            coin.rank = null
            coin.name = 'unknown'
            coin.market_cap = 0
        }
        datatable.row.add([coin.rank, coin.amount, coin.name + ' (' + coin.symbol + ')', coin.symbol]);
    } 
    datatable.columns.adjust();
    datatable.draw();
}

function generatePortfolio() {
    var investmentSum = Number($("#investmentSum")[0].value);
    var coins = [];
    var numOfCoins = $("#strategy")[0].value
    var cumMarketShare = 0;
    for (var i=0; i<numOfCoins; i++ ) {
        var coin = {}
        coin.rank = sortableCoinList[i].rank;
        coin.symbol = sortableCoinList[i].symbol;
        coin.name = sortableCoinList[i].name;
        coin.market_cap = sortableCoinList[i].quotes[currency].market_cap;
        coin.market_share = coin.market_cap / total_market_cap;
        cumMarketShare += coin.market_share;
        coin.price = sortableCoinList[i].quotes[currency].price;
        coin.amount = coin.market_share / 100 * investmentSum / coin.price;
        coin.value = coin.price * coin.amount;
        coins.push(coin);
        virtualPortfolio[coin.symbol] = coin.amount
    }
    var datatable = $('#tableVirtual').DataTable();
    datatable.clear();
    for (var key in coins) {
        var coin = coins[key];
        coin.portfolio_share = cumMarketShare * 100 * coin.value / investmentSum;     
        datatable.row.add([coin.rank, coin.name + ' (' + coin.symbol + ')', coin.price, coin.market_share, coin.portfolio_share, coin.value, coin.amount]);
    }
    datatable.columns.adjust();
    datatable.draw();
}


function analyzePortfolio() {
    portfolio_value = 0;
    var tmpPortfolio = ($("#portfolioSelection")[0].value == 'real') ? portfolio.object : virtualPortfolio;
    var coins = [];
    for (var key in tmpPortfolio) {
        var coin = {}
        if (key in coinList) {
            coin.rank = coinList[key].rank;
            coin.symbol = coinList[key].symbol;
            coin.name = coinList[key].name;
            coin.market_cap = coinList[key].quotes[currency].market_cap;
            coin.price = Number(coinList[key].quotes[currency].price.toFixed(6));
        } else {
            console.log(key + ' not in coinList')
        }
        coin.market_share = Number((100 * coin.market_cap / total_market_cap).toFixed(3));
        coin.amount = tmpPortfolio[key];
        coin.value = Number((coin.price * coin.amount).toFixed(0));
        portfolio_value += coin.value;
        coins.push(coin);
    }
    console.log('Portfolio value is ' + portfolio_value)
    for (var key in coins) {
        coins[key].portfolio_share = Number((100 * coins[key].value / portfolio_value).toFixed(2));
        var relweight = coins[key].portfolio_share / coins[key].market_share;
        if (coins[key].amount == 0) { coins[key].weight =  'not present'}
        else {
        coins[key].weight = (100*relweight).toFixed(0)
        }
            //else if (relweight < -1) { coins[key].weight =  'under'}
            // else if (relweight <= 1) { coins[key].weight =  'market'}
            // else if (relweight > 1) { coins[key].weight =  'over'}  
    }
    coins.sort(function (a, b) {
        return a.rank - b.rank;
    });
    // console.log(coins)
    var pv = portfolio_value.toLocaleString('de-CH',  { style: 'currency', currency: currency })
    var pvBTC = (portfolio_value / coinList["BTC"].quotes.USD.price).toFixed(2)
    $("#portfolioValue").html(pv + ' | ' +  pvBTC + ' BTC');
    var m2pRatio = total_market_cap / portfolio_value;
    m2pRatio = m2pRatio.toLocaleString('de-CH',  { style : 'decimal', maximumFractionDigits : 0 });
    $("#m2pRatio").html(m2pRatio);
    $('#analysis').empty(); 
    for (var key in coins) {
        var coin = coins[key];
        var tclass = (coin.amount == 0) ? 'table-dark' : '';
        var wcolor = (coin.weight <= 100) ? 'green' : 'red';
        $('#analysis').append('<tr class=' + tclass + '><th scope="row">' + coin.rank + '</th><td width=15%>' 
            + coin.amount + '</td><td>' 
            + coin.name + ' (' + coin.symbol + ')</td><td>' 
            + coin.portfolio_share + ' %</td><td>'
            + coin.market_share + ' %</td><td style="color:' + wcolor + ';">' 
            // + coin.price  + ' ' + currency + '</td><td>'
            // + coin.value  + ' ' + currency + '</td><td style="color:' + wcolor + ';">'
            + coin.weight  + '%</td></tr>');
    }
}

function fetchHistoricalPrices(list, limit) {
    historicalPrices = [];
    var numberOfCoins =list.length;
    var numberOfLastCoins = numberOfCoins % 15
    var numberOfCalls = Math.ceil(numberOfCoins/15);
    var i=0;      
    var interv = setInterval(function(){ 
        var end = (i+1 == numberOfCalls) ? i*15 + numberOfLastCoins : (i+1)*15
        var symbols = list.slice(i*15,end).map( x => x.symbol)
        $('#status').html('Getting prices for coins ' + (i*15+1) + ' to ' + end)
        getHistPrices(symbols, limit)
        i++
        if (i == numberOfCalls) { // number of coins to get hist data from 
            clearInterval(interv)
            setTimeout(function(){ 
                $('#status').html('Got historical data')
                console.log('Got historical data')
                // console.log(historicalPrices)
                prepareData();
            }, 1000)
        }
    }, 1500);  // wait a bit more than a second, 15 calls per second allowed
}

function getHistPrices(symbols, limit) {
    symbols = symbols.map( x => (x == 'MIOTA') ? 'IOT' : x )
    var limit = limit || 30; // days back
    var deferreds = []
    for (var key in symbols) {
        var symbol = symbols[key]
        deferreds.push($.get( 'https://min-api.cryptocompare.com/data/histoday', { "fsym" : symbol,  "tsym" : currency, "limit" : limit }))
    }
    $.when.apply(null, deferreds).done(function() {
        var prices = []
        if (arguments[0] instanceof Array) { // array of array, multiple ajax calls (more than 100 coins) have been made
            for( var i=0; i<arguments.length; i++ ){   
                data = arguments[i][0]
                if (data.Response == 'Success') {
                    // console.log(data.Data)
                    historicalPrices.push({ symbol : symbols[i], data: data.Data})
                } else {
                    console.log(data)
                }
            }
        } else {
            data = arguments[0]
            if (data.Response == 'Success') {
                // console.log(data.Data)
                historicalPrices.push({ symbol : symbols[0], data: data.Data})
            } else {
                console.log(data)
            } 
        }
    });
}

function prepareData() {         
    // console.log(historicalPrices)
    var normalized = $("#normalizePrices").is(":checked")
    var datasets = []
    for (var i=0; i < historicalPrices.length; i++) {
        var data = historicalPrices[i].data
        var labels = data.map( d => d.time*1000)
        var prices = data.map( d => d.close)
        var color = '#' + Math.floor(Math.random()*16777215).toString(16)
        var dataset = {}
        dataset.label = historicalPrices[i].symbol;
        var prices = data.map( d => d.close)
        var index = prices.findIndex(val => val > 0) // frist non-zero index
        prices = (normalized) ? prices.map( x => 100*x/prices[index]-100) : prices
        dataset.data = prices
        dataset.type = 'line'
        dataset.fill = false
        dataset.pointRadius = 2
        dataset.lineTension = 0 
        dataset.borderWidth = 2
        dataset.backgroundColor = color
        dataset.borderColor = color
        datasets.push(dataset)        
    }
    plotChart(labels, datasets)
}  

var myChart // must be global
function plotChart(labels, datasets) {
    if (myChart) {
        myChart.destroy();
    }
    var normalized = $("#normalizePrices").is(":checked")
    var cfg = {}
    cfg.type = 'line';
    cfg.data = {};
    cfg.data.labels = labels;
    cfg.data.datasets = datasets;
    cfg.options = {
        title: {
            display: true,
            fontSize: 14,
            text:  (normalized) ? 'Indexed coin prices':'Coin prices'
        },
        scales: {
            xAxes: [{
                type: 'time',
                time: {
                    // format: timeFormat,
                    // round: 'day',
                    tooltipFormat: 'll'
                },
                scaleLabel: {
                    display: true,
                    labelString: 'Time'
                }
            }],
            yAxes: [{
                display: true,
                // type: 'logarithmic',
                scaleLabel: {
                    display: true,
                    labelString: (normalized) ? 'Performance in %' : 'Value in ' + currency
                }, 
            }]
        },
    }
    var ctx = document.getElementById("myChart");
    myChart = new Chart(ctx, cfg);
}

/**
* Class that behaves like an associative array / object
* but actually stores its keys and values in JSON format in a localStorage key
* which can be defined when creating the object.
class Portfolio {
    constructor(storageKey) {
        storageKey = storageKey || 'cpmPortfolio'
        return new Proxy(localStorage, {
            get(target, name){
                var obj = JSON.parse(target.getItem(storageKey)) || {}
                return (name == 'object') ? obj : obj[name]
            },
            set(target, name, val) {
                var obj = JSON.parse(target.getItem(storageKey)) || {}
                if (name == 'object') {
                    target.setItem(storageKey, JSON.stringify(val));
                } else {
                    obj[name] = val
                    target.setItem(storageKey, JSON.stringify(obj));
                }
            },
            has(target, key) {
                 var obj = JSON.parse(target.getItem(storageKey)) || {}
                 return key in obj
            }, 
            deleteProperty(target, prop) {
                var obj = JSON.parse(target.getItem(storageKey)) || {}
                if (prop in obj) {
                    delete obj[prop];
                    target.setItem(storageKey, JSON.stringify(obj));
                    console.log(`property removed: ${prop}`);
                }
            }
        })
    }
}
*/

$(document).ready(function () {    
    portfolio = new Proxy(localStorage, {
            get(target, name){
                var obj = JSON.parse(target.getItem(localStorage)) || {}
                return (name == 'object') ? obj : obj[name]
            },
            set(target, name, val) {
                var obj = JSON.parse(target.getItem(localStorage)) || {}
                if (name == 'object') {
                    target.setItem(localStorage, JSON.stringify(val));
                } else {
                    obj[name] = val
                    target.setItem(localStorage, JSON.stringify(obj));
                }
            },
            has(target, key) {
                 var obj = JSON.parse(target.getItem(localStorage)) || {}
                 return key in obj
            }, 
            deleteProperty(target, prop) {
                var obj = JSON.parse(target.getItem(localStorage)) || {}
                if (prop in obj) {
                    delete obj[prop];
                    target.setItem(localStorage, JSON.stringify(obj));
                    console.log(`property removed: ${prop}`);
                }
            }
        })
    
    $( "#strategy" ).on('change', function() {
        if ($("#strategy")[0].value == 'custom') {
            generatePortfolio();
        } else {
            generatePortfolio();
        }
    });
    $( "#investmentSum" ).on('change', function() {
        generatePortfolio();
    });
    $( "#portfolioSelection" ).on('change', function() {
         analyzePortfolio();
    });
    $( "#updateChart" ).on('click', function() {
        var startDate = $('#startDate')[0].valueAsNumber
        var numberOfDays = Math.floor((Date.now()-startDate)/1000/60/60/24)
        numberOfDays = (numberOfDays < 1) ? 1 : numberOfDays
        var limit = $("#numberOfCoins")[0].value
        fetchHistoricalPrices(sortableCoinList.slice(0,limit), numberOfDays);
    });
    $( "#currency" ).on('change', function() {
        currency = $("#currency")[0].value;
        getMarketInfo();
    });
    
    $('#modalAdd button[name=apply]').on('click', function (e) {
        var amount = Number($('#modalAdd .modal-body input').val())
        var symbol = $('#modalAdd .modal-body select').val()
        if (amount != undefined && symbol != undefined) {
            dt = $('#tablePortfolio').DataTable();
            dt.row.add([coinList[symbol].rank, amount, coinList[symbol].name + ' (' + symbol + ')', symbol]);
            dt.draw();
            var data = dt.data().toArray().map( x => [x[1], x[3]]) // just return symbol and amount
            portfolio[symbol] = amount
        }
    })
    
    $('a[data-toggle="tab"]').on('show.bs.tab', function (e) {   
        $("#portfolioInfo").hide();
        $("#strategy").hide();
        $("label[for=strategy]").hide();
        $("#investmentSum").hide();
        $("label[for=investmentSum]").hide();
        if (e.target.id == 'nav-overview-tab') {
            showOverview();          
        } else if (e.target.id == 'nav-definition-tab') {
            definePortfolio();
        } else if (e.target.id == 'nav-generation-tab') {
            $("#investmentSum").show();
            $("label[for=investmentSum]").show();
            $("#strategy").show();
            $("label[for=strategy]").show();
            generatePortfolio();
        } else if (e.target.id == 'nav-analysis-tab') {
            $("#portfolioInfo").show();
            analyzePortfolio();
        } else if (e.target.id == 'nav-performance-tab') {
        }
    })
    
    
    $('#tableOverview').DataTable({
        columns : [
            { title: "Rank" },
            { title: "Coin" },
            { title: "Price" },
            { title: "1h Change" },
            { title: "24h Change" },
            { title: "7d Change" },
            { title: "Market Share" }
        ],
        columnDefs: [{targets: [3,4,5],
                        render: function ( data, type, row ) {
                          if (type == "sort" || type == 'type')
                          return data
                          var color = 'black';
                          if (data > 0) {
                            data = '+' + data + '%'
                            color = 'green';
                          } 
                          if (data < 0) {
                            data = data + '%'
                            color = 'red';
                          }
                          return '<span style="color:' + color + '">' + data + '</span>';
                        }
                    },{targets: [2],
                        render: function ( data, type, row ) {
                          if (type == "sort" || type == 'type')
                          return data
                          return data.toLocaleString(locale,  { style: 'currency', currency: currency, maximumSignificantDigits : 4 });
                        }
                    },{targets: [6],
                        render: function ( data, type, row ) {
                          if (type == "sort" || type == 'type')
                          return data
                          return data.toLocaleString(locale,  { style: 'percent', maximumSignificantDigits : 2 });
                        }
                    }],
        dom: 'Blftrip',
        select: true,
        paging: false,
        order: [[ 0, "asc" ]],
        buttons: [
            {
                extend: 'collection',
                text: 'Export',
                buttons: [
                    'copy', 
                    'print',
                    'csv',
                    'excel', 
                    'pdf'
                ]
            }
        ]           
    });
    
    // dataTable Portfolio
    $('#tablePortfolio').DataTable({
        columns : [
            { title: "Rank" },
            { title: "Amount" },
            { title: "Name" },
            { title: "Symbol" }
        ],
        columnDefs: [{
                        "targets": [],
                        "visible": false
                    }],
        dom: 'Blftrip',
        select: true,
        paging: false,
        buttons: [
            {
                text: 'Add',
                action: function ( e, dt, node, config ) {
                    $('#modalAdd .modal-body').empty()
                    $('#modalAdd').modal()
                    var el = document.createElement('select');                   
                    for (var key in coinList) {
                        if (portfolio && !(key in portfolio)) {
                            el.options.add(new Option(key,key))
                        } 
                    } 
                    if (el.options.length) {
                        $('#modalAdd .modal-body').append(el)
                        $('#modalAdd .modal-body').append('<input type=number>')
                    } else {
                        $('#modalAdd .modal-body').html('All available coins are already in portfolio')
                        console.warn('All available coins are already in portfolio')
                    }
                }
            }, 
            /*
            {
                extend: 'selectedSingle',
                text: 'Edit',
                action: function ( e, dt, node, config ) {
                    var idx = dt.row( { selected: true } ).index()
                    console.log('Will modify row ' + idx)
                }
            },
            */
            {
                extend: 'selectedSingle',
                text: 'Delete',
                action: function ( e, dt, node, config ) {
                    var symbol = dt.row({ selected : true }).data()[3]
                    dt.row({ selected : true }).remove().draw();
                    console.log(symbol)
                    delete portfolio[symbol]
                }
            },             
            {
                extend: 'collection',
                text: 'Export',
                buttons: [
                    // 'colvis',
                    'copy', 
                    'print',
                    'csv',
                    'excel', 
                    'pdf',
                    {
                        text: 'Copy JSON',
                        action: function ( e, dt, node, config ) {
                            alert(JSON.stringify(portfolio.object))
                        }
                    }
                ]
            }
        ]           
    });
    
    $('#tableVirtual').DataTable({
        columns : [
            { title: "Rank" },
            { title: "Coin" },
            { title: "Price" },
            { title: "Market Share" },
            { title: "Portfolio Share" },
            { title: "Value" },
            { title: "Amount" }
        ],
        columnDefs:  [{targets: [2,5],
                        render: function ( data, type, row ) {
                          if (type == "sort" || type == 'type')
                          return data
                          return data.toLocaleString(locale,  { style: 'currency', currency: currency, maximumSignificantDigits : 4 });
                        }
                    },{targets: [3,4],
                        render: function ( data, type, row ) {
                          if (type == "sort" || type == 'type')
                          return data
                          return data.toLocaleString(locale,  { style: 'percent', maximumSignificantDigits : 2 });
                        }
                    }],
        dom: 'Blftrip',
        select: true,
        paging: false,
        buttons: [
            {
                text: 'Options',
                action: function ( e, dt, node, config ) {
                    $('#modalAdd .modal-body').empty()
                    $('#modalAddTitle').html('Settings')
                    var label = document.createElement('label')
                    label.setAttribute('for', 'sum')
                    label.textContent = 'Investment sum'
                    var sum = document.createElement('input'); 
                    sum.id = 'sum'
                    sum.value = 1000
                    console.dir(label, sum)
                    $('#modalAdd .modal-body').append(label, sum)    
                    $('#modalAdd').modal()                    
                }
            }, 
            {
                text: 'Add',
                action: function ( e, dt, node, config ) {
                    $('#modalAdd .modal-body').empty()
                    $('#modalAdd').modal()
                    var el = document.createElement('select');                   
                    for (var key in coinList) {
                        if (!(key in virtualPortfolio)) {
                            el.options.add(new Option(key,key))
                        } 
                    } 
                    if (el.options.length) {
                        $('#modalAdd .modal-body').append(el)
                        $('#modalAdd .modal-body').append('<input type=number>')
                    } else {
                        $('#modalAdd .modal-body').html('All available coins are already in portfolio')
                        console.warn('All available coins are already in portfolio')
                    }
                }
            }, 
            {
                extend: 'selectedSingle',
                text: 'Delete',
                action: function ( e, dt, node, config ) {
                    var symbol = dt.row({ selected : true }).data()[0]
                    if (delete virtualPortfolio[symbol]) {
                        dt.row({ selected : true }).remove().draw();
                    }
                }
            },             
            {
                extend: 'collection',
                text: 'Export',
                buttons: [
                    // 'colvis',
                    'copy', 
                    'print',
                    'csv',
                    'excel', 
                    'pdf'
                ]
            }
        ]           
    });  
    
    $('startDate').valueAsDate = new Date()
    $("#portfolioInfo").hide();
    $("#strategy").hide();
    $("label[for=strategy]").hide();
    $("#investmentSum").hide();
    $("label[for=investmentSum]").hide();
    // portfolio = JSON.parse(localStorage.getItem('portfolio')) || {};
    getMarketInfo();
});
</script>
</body>
</html>